{% extends "base.html" %}

{% block title %}Watch {{ anime_title }} - {{ subtitle }}{% endblock %}

{% block extra_css %}
<style>
    body {
        background: #0f0f0f;
        margin: 0;
        padding: 0;
    }
    
    .watch-container {
        display: grid;
        grid-template-columns: 1fr 400px;
        gap: 0;
        max-width: 100%;
        margin: 0;
        height: 100vh;
        overflow: hidden;
        margin-right: 10px;
    }
    
    /* Left Side - Player Section */
    .player-section {
        background: #000;
        display: flex;
        flex-direction: column;
        height: 100vh;
        overflow-y: auto;
    }
    
    /* Navigation Bar */
    .player-nav {
        background: rgba(20, 20, 20, 0.95);
        backdrop-filter: blur(10px);
        padding: 1rem 2rem;
        display: flex;
        align-items: center;
        gap: 1rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        flex-shrink: 0;
    }
    
    .nav-link {
        color: rgba(255, 255, 255, 0.7);
        text-decoration: none;
        font-size: 0.95rem;
        transition: color 0.3s;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .nav-link:hover { color: #fff; }
    .nav-separator { color: rgba(255, 255, 255, 0.3); }
    .nav-link.active { color: #fff; font-weight: 600; }
    
    /* Iframe Wrapper */
    .video-wrapper {
        position: relative;
        background: #000;
        width: 100%;
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 0;
    }
    
    #player-iframe {
        width: 100%;
        height: 100%;
        border: none;
        background: #000;
    }
    
    .video-overlay {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
    }
    
    .video-title {
        font-size: 2rem;
        color: rgba(255, 255, 255, 0.9);
        margin-bottom: 0.5rem;
    }
    
    /* Control Bar */
    .control-bar {
        background: rgba(20, 20, 20, 0.95);
        backdrop-filter: blur(10px);
        padding: 1rem 2rem;
        display: flex;
        align-items: center;
        gap: 1rem;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        flex-shrink: 0;
        flex-wrap: wrap;
    }
    
    .control-btn {
        background: transparent;
        border: none;
        color: rgba(255, 255, 255, 0.7);
        cursor: pointer;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        transition: all 0.3s;
    }
    
    .control-btn:hover { background: rgba(255, 255, 255, 0.1); color: #fff; }
    .control-btn.active { color: #ff5722; }
    
    /* Right Sidebar - Episodes */
    .episodes-sidebar {
        background: #1a1a1a;
        height: 100vh;
        display: flex;
        flex-direction: column;
        border-left: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .sidebar-header { padding: 1.5rem; border-bottom: 1px solid rgba(255, 255, 255, 0.1); flex-shrink: 0; }
    .sidebar-title { font-size: 1.2rem; font-weight: 600; color: #fff; margin: 0 0 1rem 0; }
    
    .search-input {
        width: 100%;
        padding: 0.7rem 1rem;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        color: #fff;
    }

    /* Episodes List */
    .episodes-list {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
    }
    
    .episode-item {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 0.75rem;
        text-decoration: none;
        color: inherit;
        display: block;
        transition: 0.3s;
    }
    
    .episode-item:hover { background: rgba(255, 255, 255, 0.08); }
    .episode-item.active {
        background: rgba(255, 87, 34, 0.1);
        border-color: #ff5722;
        color: #ff5722;
    }
    
    /* Servers Section */
    .servers-section {
        padding: 1.5rem 2rem;
        background: rgba(255, 255, 255, 0.02);
        border-top: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .servers-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
        gap: 0.5rem;
    }
    
    .server-btn {
        padding: 0.6rem;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 6px;
        color: #fff;
        cursor: pointer;
        text-align: center;
    }
    
    .server-btn.active { color: #ff5722; border-color: #ff5722; background: rgba(255, 87, 34, 0.05); }

    /* Mobile Handling */
    @media (max-width: 992px) {
        .watch-container { grid-template-columns: 1fr; height: auto; overflow: visible; }
        .episodes-sidebar { height: auto; max-height: 500px; border-left: none; border-top: 1px solid #333; }
        .video-wrapper { aspect-ratio: 16 / 9; flex: none; }
        .player-section { height: auto; }
    }
</style>
{% endblock %}

{% block content %}
<div class="watch-container">
    <div class="player-section">
        <nav class="player-nav">
            <a href="/" class="nav-link">Home</a>
            <span class="nav-separator">/</span>
            <span class="nav-link active">{{ anime_info.title }}</span>
        </nav>
        
        <div class="video-wrapper">
            {% if streams and streams.sources %}
                <iframe 
                    id="player-iframe" 
                    src="{{ streams.sources[0].url }}" 
                    allowfullscreen="true" 
                    scrolling="no" 
                    allow="autoplay; fullscreen"
                    autoplay>
                </iframe>
            {% else %}
                <div class="video-overlay">
                    <h2 class="video-title">{{ anime_title }}</h2>
                    <p class="video-subtitle">Video sources not found.</p>
                </div>
            {% endif %}
        </div>
        
        <div class="control-bar">
            <button class="control-btn"><i class="fa-solid fa-moon"></i> Focus</button>
            <button class="control-btn active"><i class="fa-solid fa-forward"></i> AutoNext</button>
            <button class="control-btn"><i class="fa-solid fa-play"></i> AutoPlay</button>
            <button class="control-btn"><i class="fa-solid fa-backward-step"></i> Prev</button>
            <button class="control-btn"><i class="fa-solid fa-forward-step"></i></i> Next</button>
            <button class="control-btn"><i class="fa-solid fa-exclamation"></i> Report</button>
        </div>
        
        {% if servers %}
        <div class="servers-section">
            <div class="servers-title" style="color: #888; margin-bottom: 10px; font-size: 0.9rem;">Available Servers:</div>
            <div class="servers-grid">
                {% for server in servers %}
                <button class="server-btn {% if loop.index == 1 %}active{% endif %}" 
                        onclick="changeServer('{{ server.url }}', this)">
                    {{ server.name }}
                </button>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
    
    <aside class="episodes-sidebar">
        <div class="sidebar-header">
            <h3 class="sidebar-title">Episodes</h3>
            <div class="sidebar-search">
                <input type="text" class="search-input" placeholder="# Find episode...">
            </div>
        </div>
        
        <div class="episodes-list">
            {% if anime_info.episodes %}
                {% for episode in anime_info.episodes %}
                {% set id_parts = episode.id.split('$') %}
                <a href="/watch/{{ id_parts[0] }}?{{ id_parts[1] }}" class="episode-item {% if episode.number|string == current_episode|string %}active{% endif %}">
                    <div class="episode-title">
                        {{ episode.number }}. {{ episode.title or 'Episode ' ~ episode.number }}
                    </div>
                </a>
                {% endfor %}
            {% else %}
                <div class="episode-item active">
                    <div class="episode-number">1 Complete Movie</div>
                </div>
            {% endif %}
        </div>
    </aside>
</div>
{% endblock %}

{% block extra_js %}
<script>
    /**
     * Changes the iframe source and manages active button state
     */
    function changeServer(url, btnElement) {
        const iframe = document.getElementById('player-iframe');
        if (iframe && url) {
            iframe.src = url;
            
            // Manage button active states
            document.querySelectorAll('.server-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            btnElement.classList.add('active');
        }
    }
    
    // Toggle logic for control bar buttons
    document.querySelectorAll('.control-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            this.classList.toggle('active');
        });
    });

    // Simple episode search filter
    const searchInput = document.querySelector('.search-input');
    if (searchInput) {
        searchInput.addEventListener('input', function(e) {
            const term = e.target.value.toLowerCase();
            document.querySelectorAll('.episode-item').forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(term) ? 'block' : 'none';
            });
        });
    }
</script>
{% endblock %}