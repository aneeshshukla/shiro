{% extends "base.html" %}

{% block title %}Watch {{ anime_title }} - {{ subtitle }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/watch.css') }}">
{% endblock %}

{% block content %}
<div class="watch-container">
    <div class="player-section">
        <nav class="player-nav">
            <a href="/" class="nav-link">Home</a>
            <span class="nav-separator">/</span>
            <span class="nav-link active">{{ anime_info.title }}</span>
        </nav>
        
        <div class="video-wrapper">
            {% if streams and streams.sources %}
                <iframe 
                    id="player-iframe" 
                    src="{{ streams.sources[0].url }}" 
                    allowfullscreen="true" 
                    scrolling="no" 
                    allow="autoplay; fullscreen"
                    autoplay>
                </iframe>
            {% else %}
                <div class="video-overlay">
                    <h2 class="video-title">{{ anime_title }}</h2>
                    <p class="video-subtitle">Video sources not found.</p>
                </div>
            {% endif %}
        </div>
        
        <div class="control-bar">
            <button class="control-btn"><i class="fa-solid fa-moon"></i> Focus</button>
            <button class="control-btn active"><i class="fa-solid fa-forward"></i> AutoNext</button>
            <button class="control-btn"><i class="fa-solid fa-play"></i> AutoPlay</button>
            <button class="control-btn"><i class="fa-solid fa-backward-step"></i> Prev</button>
            <button class="control-btn"><i class="fa-solid fa-forward-step"></i></i> Next</button>
            <button class="control-btn"><i class="fa-solid fa-exclamation"></i> Report</button>
        </div>
        
        {% if servers %}
        <div class="servers-section">
            <div class="servers-title" style="color: #888; margin-bottom: 10px; font-size: 0.9rem;">Available Servers:</div>
            <div class="servers-grid">
                {% for server in servers %}
                <button class="server-btn {% if loop.index == 1 %}active{% endif %}" 
                        onclick="changeServer('{{ server.url }}', this)">
                    {{ server.name }}
                </button>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
    
    <aside class="episodes-sidebar">
        <div class="sidebar-header">
            <h3 class="sidebar-title">Episodes</h3>
            <div class="sidebar-search">
                <input type="text" class="search-input" placeholder="# Find episode...">
            </div>
        </div>
        
        <div class="episodes-list">
            {% if anime_info.episodes %}
                {% for episode in anime_info.episodes %}
                {% set id_parts = episode.id.split('$') %}
                <a href="/watch/{{ id_parts[0] }}?{{ id_parts[1] }}" class="episode-item {% if episode.number|string == current_episode|string %}active{% endif %}">
                    <div class="episode-title">
                        {{ episode.number }}. {{ episode.title or 'Episode ' ~ episode.number }}
                    </div>
                </a>
                {% endfor %}
            {% else %}
                <div class="episode-item active">
                    <div class="episode-number">1 Complete Movie</div>
                </div>
            {% endif %}
        </div>
    </aside>
</div>
{% endblock %}

{% block extra_js %}
<script>
    /**
     * Changes the iframe source and manages active button state
     */
    function changeServer(url, btnElement) {
        const iframe = document.getElementById('player-iframe');
        if (iframe && url) {
            iframe.src = url;
            
            // Manage button active states
            document.querySelectorAll('.server-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            btnElement.classList.add('active');
        }
    }
    
    // Toggle logic for control bar buttons
    document.querySelectorAll('.control-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            this.classList.toggle('active');
        });
    });

    // Simple episode search filter
    const searchInput = document.querySelector('.search-input');
    if (searchInput) {
        searchInput.addEventListener('input', function(e) {
            const term = e.target.value.toLowerCase();
            document.querySelectorAll('.episode-item').forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(term) ? 'block' : 'none';
            });
        });
    }
</script>
{% endblock %}