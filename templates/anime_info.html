{% extends "base.html" %}

{% block title %}{{ anime.title.english or anime.title.romaji or 'Anime' }} - AnimeTown{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/info.css') }}?v=2">
{% endblock %}

{% block content %}
    <!-- Banner Hero -->
    <div class="info-banner">
        <div class="banner-bg" style="background-image: url('{{ anime.cover or anime.image }}');"></div>
        <div class="banner-overlay"></div>

        <div class="banner-content">
            <div class="banner-poster">
                <div class="poster-wrapper skeleton">
                    <img src="{{ anime.image }}" alt="{{ anime.title.english or anime.title.romaji }}" loading="lazy" onload="this.parentElement.classList.add('loaded'); this.parentElement.classList.remove('skeleton');">
                </div>
            </div>

            <div class="banner-info">
                <div class="info-sub-title">{{ anime.title.native or '' }}</div>
                <h1 class="info-title">{{ anime.title.english or anime.title.romaji }}</h1>

                <div class="info-stats">
                    {% if anime.rating %}
                    <div class="stat-pill rating-pill">
                        <i class="fa-solid fa-star"></i>
                        <span>{{ (anime.rating / 10)|round(1) }}</span>
                    </div>
                    {% endif %}
                    <div class="stat-pill">
                        <i class="fa-solid fa-tv"></i>
                        <span>{{ anime.type or 'TV' }}</span>
                    </div>
                    {% if anime.duration %}
                    <div class="stat-pill">
                        <i class="fa-regular fa-clock"></i>
                        <span>{{ anime.duration }}m</span>
                    </div>
                    {% endif %}
                    {% if anime.totalEpisodes %}
                    <div class="stat-pill">
                        <i class="fa-solid fa-layer-group"></i>
                        <span>{{ anime.currentEpisode or '?' }}/{{ anime.totalEpisodes }} eps</span>
                    </div>
                    {% endif %}
                    <div class="stat-pill status-{{ anime.status|lower if anime.status else 'unknown' }}">
                        <i class="fa-solid fa-circle" style="font-size: 0.5rem;"></i>
                        <span>{{ anime.status or 'Unknown' }}</span>
                    </div>
                </div>

                <div class="info-genres">
                    {% if anime.genres %}
                        {% for genre in anime.genres %}
                        <a href="/genre/{{ genre }}" class="genre-chip">{{ genre }}</a>
                        {% endfor %}
                    {% endif %}
                </div>

                <div class="info-actions">
                    {% if anime.episodes and anime.episodes|length > 0 %}
                        <a href="/watch/{{ anime.id }}?ep=1" class="btn-primary">
                            <i class="fa-solid fa-play"></i> Watch Now
                        </a>
                    {% else %}
                        <button class="btn-primary disabled" disabled>
                            <i class="fa-solid fa-play"></i> Not Available
                        </button>
                    {% endif %}
                    <button class="btn-secondary">
                        <i class="fa-solid fa-plus"></i> Add to List
                    </button>
                    {% if anime.trailer %}
                    <a href="https://youtube.com/watch?v={{ anime.trailer.id }}" target="_blank" class="btn-secondary">
                        <i class="fa-brands fa-youtube"></i> Trailer
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="info-container">
        <div class="info-main">

            <!-- Synopsis -->
            <section class="info-section">
                <h2 class="section-heading">Synopsis</h2>
                <div class="synopsis-text" id="synopsis-text">
                    <p>{{ anime.description|safe }}</p>
                </div>
                <button class="synopsis-toggle" id="synopsis-toggle" onclick="toggleSynopsis()">Read More</button>
            </section>

            <!-- Details Grid -->
            <section class="info-section">
                <h2 class="section-heading">Details</h2>
                <div class="details-grid">
                    <div class="detail-item">
                        <span class="detail-label">Japanese</span>
                        <span class="detail-value">{{ anime.title.native or '-' }}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Romaji</span>
                        <span class="detail-value">{{ anime.title.romaji or '-' }}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Aired</span>
                        <span class="detail-value">
                            {% if anime.startDate and anime.startDate.year %}
                                {{ anime.startDate.month or '?' }}/{{ anime.startDate.day or '?' }}/{{ anime.startDate.year }}
                                {% if anime.endDate and anime.endDate.year %}
                                â€” {{ anime.endDate.month or '?' }}/{{ anime.endDate.day or '?' }}/{{ anime.endDate.year }}
                                {% endif %}
                            {% else %}
                                {{ anime.releaseDate or '-' }}
                            {% endif %}
                        </span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Premiered</span>
                        <span class="detail-value">{{ anime.season or '-' }} {{ anime.releaseDate or '' }}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Studios</span>
                        <span class="detail-value accent">{{ anime.studios|join(', ') if anime.studios else '-' }}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Duration</span>
                        <span class="detail-value">{{ anime.duration or '-' }} min/ep</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Status</span>
                        <span class="detail-value">{{ anime.status or '-' }}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Rating</span>
                        <span class="detail-value">{{ (anime.rating / 10)|round(1) if anime.rating else 'N/A' }} / 10</span>
                    </div>
                </div>
            </section>

            <!-- Episodes -->
            {% if anime.episodes and anime.episodes|length > 0 %}
            <section class="info-section">
                <div class="section-heading-row">
                    <h2 class="section-heading">Episodes</h2>
                    <span class="episode-count">{{ anime.episodes|length }} Episodes</span>
                </div>
                <div class="episodes-list" id="episodes-list">
                    {% for ep in anime.episodes %}
                    <a href="/watch/{{ anime.id }}?ep={{ ep.number }}" class="episode-card">
                        <div class="ep-number">{{ ep.number }}</div>
                        <div class="ep-info">
                            <div class="ep-title">{{ ep.title or ('Episode ' ~ ep.number) }}</div>
                            <div class="ep-badges">
                                {% if ep.isSubbed %}<span class="ep-badge sub">SUB</span>{% endif %}
                                {% if ep.isDubbed %}<span class="ep-badge dub">DUB</span>{% endif %}
                                {% if ep.isFiller %}<span class="ep-badge filler">FILLER</span>{% endif %}
                            </div>
                        </div>
                        <i class="fa-solid fa-play ep-play"></i>
                    </a>
                    {% endfor %}
                </div>
                {% if anime.episodes|length > 12 %}
                <button class="show-all-eps-btn" id="show-all-eps" onclick="toggleEpisodes()">
                    Show All Episodes <i class="fa-solid fa-chevron-down"></i>
                </button>
                {% endif %}
            </section>
            {% endif %}

            <!-- Characters -->
            {% if anime.characters and anime.characters|length > 0 %}
            <section class="info-section">
                <h2 class="section-heading">Characters</h2>
                <div class="characters-grid">
                    {% for char in anime.characters[:12] %}
                    <div class="character-card">
                        <div class="char-img-wrapper">
                            <div class="poster-wrapper skeleton" style="padding-top: 100%; border-radius: 50%;">
                                <img src="{{ char.image }}" alt="{{ char.name.full }}" loading="lazy" onload="this.parentElement.classList.add('loaded'); this.parentElement.classList.remove('skeleton');" style="border-radius: 50%;">
                            </div>
                        </div>
                        <div class="char-name">{{ char.name.full }}</div>
                        <div class="char-role">{{ char.role }}</div>
                        {% if char.voiceActors and char.voiceActors|length > 0 %}
                        <div class="char-va">
                            <img src="{{ char.voiceActors[0].image }}" alt="{{ char.voiceActors[0].name.full }}" loading="lazy">
                            <span>{{ char.voiceActors[0].name.full }}</span>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </section>
            {% endif %}

            <!-- Relations -->
            {% if anime.relations and anime.relations|length > 0 %}
            <section class="info-section">
                <h2 class="section-heading">Related</h2>
                <div class="relations-grid">
                    {% for rel in anime.relations %}
                    <a href="/anime/{{ rel.id }}" class="relation-card">
                        <div class="rel-poster">
                            <div class="poster-wrapper skeleton" style="padding-top: 140%;">
                                <img src="{{ rel.image }}" alt="{{ rel.title.userPreferred or rel.title }}" loading="lazy" onload="this.parentElement.classList.add('loaded'); this.parentElement.classList.remove('skeleton');">
                            </div>
                        </div>
                        <div class="rel-info">
                            <span class="rel-type">{{ rel.relationType }}</span>
                            <span class="rel-title">{{ rel.title.userPreferred or rel.title }}</span>
                        </div>
                    </a>
                    {% endfor %}
                </div>
            </section>
            {% endif %}

            <!-- Recommendations -->
            {% set recs = anime.recommendations if anime.recommendations else [] %}
            {% if recs|length > 0 %}
            <section class="info-section">
                <h2 class="section-heading">Recommendations</h2>
                <div class="rec-grid">
                    {% for rec in recs[:15] %}
                    <a href="/anime/{{ rec.id }}" class="rec-card">
                        <div class="rec-poster">
                            <div class="poster-wrapper skeleton" style="padding-top: 140%;">
                                <img src="{{ rec.image }}" alt="{{ rec.title.userPreferred or rec.title }}" loading="lazy" onload="this.parentElement.classList.add('loaded'); this.parentElement.classList.remove('skeleton');">
                            </div>
                            <div class="rec-overlay">
                                <span class="rec-rating">
                                    {% if rec.rating %}<i class="fa-solid fa-star"></i> {{ (rec.rating / 10)|round(1) }}{% endif %}
                                </span>
                                <span class="rec-type">{{ rec.type or 'TV' }}</span>
                            </div>
                        </div>
                        <h3 class="rec-title">{{ rec.title.userPreferred or rec.title }}</h3>
                    </a>
                    {% endfor %}
                </div>
            </section>
            {% endif %}

        </div>

        <!-- Sidebar -->
        <aside class="info-sidebar">
            {% if anime.nextAiringEpisode %}
            <div class="sidebar-card airing-card">
                <h3 class="sidebar-card-title"><i class="fa-solid fa-broadcast-tower"></i> Next Episode</h3>
                <div class="airing-info">
                    <div class="airing-ep">Episode {{ anime.nextAiringEpisode.episode }}</div>
                    <div class="airing-countdown" id="airing-countdown" data-time="{{ anime.nextAiringEpisode.timeUntilAiring }}">
                        Calculating...
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Popular Sidebar -->
            {% if most_popular %}
            <div class="sidebar-card">
                <h3 class="sidebar-card-title"><i class="fa-solid fa-fire"></i> Most Popular</h3>
                <div class="popular-list">
                    {% set pop_list = most_popular if most_popular is iterable and most_popular is not mapping else [] %}
                    {% for item in pop_list[:8] %}
                    <a href="/anime/{{ item.id }}" class="popular-item">
                        <div class="pop-rank {% if loop.index <= 3 %}top{% endif %}">{{ loop.index }}</div>
                        <div class="poster-wrapper skeleton" style="width: 45px; height: 62px; padding-top: 0; flex-shrink: 0; border-radius: 6px;">
                            <img src="{{ item.image }}" alt="{{ item.title.userPreferred or item.title }}" class="pop-img" loading="lazy" onload="this.parentElement.classList.add('loaded'); this.parentElement.classList.remove('skeleton');">
                        </div>
                        <div class="pop-details">
                            <h4 class="pop-title">{{ item.title.userPreferred or item.title }}</h4>
                            <div class="pop-meta">
                                <span>{{ item.type or 'TV' }}</span>
                                {% if item.rating %}<span class="pop-rating"><i class="fa-solid fa-star"></i> {{ (item.rating / 10)|round(1) }}</span>{% endif %}
                            </div>
                        </div>
                    </a>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </aside>
    </div>

{% endblock %}

{% block extra_js %}
<script>
// Synopsis toggle
function toggleSynopsis() {
    const text = document.getElementById('synopsis-text');
    const btn = document.getElementById('synopsis-toggle');
    text.classList.toggle('expanded');
    btn.textContent = text.classList.contains('expanded') ? 'Show Less' : 'Read More';
}

// Episodes toggle
function toggleEpisodes() {
    const list = document.getElementById('episodes-list');
    const btn = document.getElementById('show-all-eps');
    list.classList.toggle('show-all');
    if (list.classList.contains('show-all')) {
        btn.innerHTML = 'Show Less <i class="fa-solid fa-chevron-up"></i>';
    } else {
        btn.innerHTML = 'Show All Episodes <i class="fa-solid fa-chevron-down"></i>';
    }
}

// Countdown timer for next airing episode
const countdownEl = document.getElementById('airing-countdown');
if (countdownEl) {
    let remaining = parseInt(countdownEl.dataset.time);
    function updateCountdown() {
        if (remaining <= 0) {
            countdownEl.textContent = 'Airing Now!';
            return;
        }
        const d = Math.floor(remaining / 86400);
        const h = Math.floor((remaining % 86400) / 3600);
        const m = Math.floor((remaining % 3600) / 60);
        const s = remaining % 60;
        let parts = [];
        if (d > 0) parts.push(d + 'd');
        parts.push(h + 'h');
        parts.push(m + 'm');
        parts.push(s + 's');
        countdownEl.textContent = parts.join(' ');
        remaining--;
    }
    updateCountdown();
    setInterval(updateCountdown, 1000);
}
</script>
{% endblock %}