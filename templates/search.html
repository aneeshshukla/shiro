{% extends "base.html" %}

{% block title %}Search Results - AnimeTown{% endblock %}

{% block head %}
<!-- FontAwesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/search.css') }}">
{% endblock %}

{% block content %}
<div class="container search-page-container">
    {% if query %}
    <div class="filter-container">
        <div class="filter-header">
            <h2>BROWSER</h2>
            <div class="filter-count">
                {% set res_count = results.results|length if results and results.results else (results|length if results else 0) %}
                {{ res_count }} anime
            </div>
        </div>
        
        <form action="/search" method="get" class="filter-bar">
            <!-- Search Input -->
            <div class="filter-input-wrapper">
                <input type="text" name="q" placeholder="Search..." value="{{ query or '' }}" autocomplete="off">
                <i class="fa-solid fa-magnifying-glass"></i>
            </div>
            
            <!-- Filters -->
            <div class="filter-select-wrapper">
                <select name="type">
                    <option value="">Type</option>
                    <option value="Movie">Movie</option>
                    <option value="TV">TV</option>
                    <option value="OVA">OVA</option>
                    <option value="ONA">ONA</option>
                </select>
            </div>
            <div class="filter-select-wrapper">
                <select name="genre">
                    <option value="">Genre</option>
                    <option value="Action">Action</option>
                    <option value="Adventure">Adventure</option>
                    <option value="Comedy">Comedy</option>
                    <option value="Drama">Drama</option>
                    <option value="Fantasy">Fantasy</option>
                </select>
            </div>
             <div class="filter-select-wrapper">
                <select name="status">
                    <option value="">Status</option>
                    <option value="Finished Airing">Finished</option>
                    <option value="Currently Airing">Airing</option>
                    <option value="Not yet aired">Upcoming</option>
                </select>
            </div>
             <div class="filter-select-wrapper">
                <select name="sort">
                    <option value="">Most relevance</option>
                    <option value="latest">Latest</option>
                    <option value="popular">Popular</option>
                </select>
            </div>

            <!-- Buttons -->
            <button type="button" class="filter-btn-settings"><i class="fa-solid fa-sliders"></i></button>
            <button type="submit" class="filter-btn-submit"><i class="fa-solid fa-filter"></i> Filter</button>
        </form>
    </div>
        
        {# Normalize results: could be list or dict with 'results' key #}
        {% set anime_list = results.results if results and results.results is defined else (results if results else []) %}

        {% if anime_list %}
            <div class="anime-grid">
                {% for anime in anime_list %}
                <a href="/anime/{{ anime.id }}" class="anime-card-link" style="text-decoration: none; display: block;">
                    <div class="anime-card">
                        <div class="poster-wrapper skeleton">
                            <img src="{{ anime.image }}" alt="{{ anime.title }}" loading="lazy" onload="this.parentElement.classList.add('loaded'); this.parentElement.classList.remove('skeleton');">
                        </div>
                        <div class="play-icon"><i class="fa-solid fa-play"></i></div>
                        
                        <div class="anime-card-overlay">
                            <div class="card-title">{{ anime.title }}</div>
                            <div class="card-meta">
                                <span>{{ anime.releaseDate or anime.type or 'TV' }}</span>
                                {% if anime.sub %} • <span title="Sub"><i class="fa-solid fa-closed-captioning"></i> {{ anime.sub }}</span>{% endif %}
                                {% if anime.dub %} • <span title="Dub"><i class="fa-solid fa-microphone"></i> {{ anime.dub }}</span>{% endif %}
                            </div>
                        </div>
                    </div>
                </a>
                {% endfor %}
            </div>
            
            {# Pagination Logic #}
            {% if (results.hasNextPage is defined and results.hasNextPage) or (anime_list|length >= 20) or page > 1 %}
            <div class="pagination">
                {% if page > 1 %}
                <a href="?q={{ query }}&page={{ page - 1 }}"><i class="fa-solid fa-chevron-left"></i> Previous</a>
                {% endif %}
                
                <span class="current">Page {{ page }}</span>
                
                {% if (results.hasNextPage is defined and results.hasNextPage) or (anime_list|length >= 20) %}
                <a href="?q={{ query }}&page={{ page + 1 }}">Next <i class="fa-solid fa-chevron-right"></i></a>
                {% endif %}
            </div>
            {% endif %}

        {% else %}
            <div class="no-results">
                <i class="fa-solid fa-magnifying-glass-minus"></i>
                <h3>No results found</h3>
                <p>We couldn't find any anime matching "{{ query }}". Try different keywords.</p>
            </div>
        {% endif %}
    {% else %}
        <div class="no-results" style="padding-top: 10%;">
            <i class="fa-solid fa-magnifying-glass"></i>
            <h3>Search Anime</h3>
            <p>Type in the search bar above to find your favorite anime.</p>
        </div>
    {% endif %}
</div>
{% endblock %}